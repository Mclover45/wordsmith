kind: pipeline
type: docker
name: default

environment:
  AWS_ACCESS_KEY_ID: AWS_ACCESS_KEY_ID
  GOARCH: amd64
  AWS_ACCESS_KEY_ID=AKIAQUL6SMGRSKYMFEG3   
  AWS_SECRET_ACCESS_KEY=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


steps:
- name: Cluster install
  image: ubuntu
  commands:
  - apt-get update 
  - apt-get install -y curl
  - curl -Lo kops https://github.com/kubernetes/kops/releases/download/$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d '"' -f 4)/kops-linux-amd64
  - chmod +x kops
  - mv kops /usr/local/bin/kops

curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
chmod +x ./kubectl
mv ./kubectl /usr/local/bin/kubectl

  kops create cluster --name=wordsmith.rbachkarou.tl.scntl.com --state=s3://rbachkarou-kops --zones=eu-central-1a --node-count=2 --node-size=t3.medium --master-size=t3.medium
  kops update cluster --name wordsmith.rbachkarou.tl.scntl.com --yes --admin --state=s3://rbachkarou-kops


curl -L https://github.com/drone-runners/drone-runner-exec/releases/latest/download/drone_runner_exec_linux_arm.tar.gz | tar zx

  kubectl label namespace default istio-injection=enabled
  