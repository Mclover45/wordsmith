kind: pipeline
type: docker
name: default

steps:
- name: Cluster install
  image: ubuntu
  environment:
    AWS_ACCESS_KEY_ID:
      from_secret: AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY:
      from_secret: AWS_SECRET_ACCESS_KEY
  commands:
  - apt-get update 
  - apt-get install -y curl
  # Kops install
  - curl -Lo kops https://github.com/kubernetes/kops/releases/download/$(curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d '"' -f 4)/kops-linux-amd64
  - chmod +x kops
  - mv kops /usr/local/bin/kops
  # Kubectl install
  - curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
  - chmod +x ./kubectl
  - mv ./kubectl /usr/local/bin/kubectl
  # Create cluster
  - kops create cluster --name=wordsmith.rbachkarou.tl.scntl.com --state=s3://rbachkarou-kops --zones=eu-central-1a --node-count=2 --node-size=t3.medium --master-size=t3.medium
  - kops update cluster --name wordsmith.rbachkarou.tl.scntl.com --yes --admin --state=s3://rbachkarou-kops
  # Istio install 
  - curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.13.2 TARGET_ARCH=x86_64 sh -
  - /istio-1.13.2/bin/istioctl install --set profile=minimal -y
  # Labeled for istio
  - kubectl label namespace wordsmith istio-injection=enabled
  # install grafana and kiali
  - kubectl apply -f /istio-1.13.2/samples/addons/kiali.yaml
  - kubectl apply -f /istio-1.13.2/samples/addons/grafana.yaml
  # Install helm
  - curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
  - chmod 700 get_helm.sh
  - ./get_helm.sh
  
  
  # App install
  - git clone https://github.com/Mclover45/wordsmith
  - helm install wordsmith-demo /wordsmith/helm/wordsmith-demo
  # ingress install
  - kubectl appply -f ic-nginx-lb.yaml
  - kubectl appply -f app-ingress.yml
  # Give data
  - kubectl get svc --all-namespaces

